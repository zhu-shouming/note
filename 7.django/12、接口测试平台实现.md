### 一、项目分析

#### 1.架构设计

- 结构模式
  - 前后端分离
- 前端架构
  - vue + element ui + vue router + axios
- 后端架构
  - Django + Django RestFramework + mysql + coreapi + httprunner + yaml
- 数据库选型
- 源代码管理

#### 2.数据库设计

- 数据库表的设计至关重要
- 根据项目需求，设计合适的数据库表
- 数据库表在前期设计不合理，后期需求增加会变的难以维护

#### 3.测试平台结构

- 主要为接口测试平台
- 项目模块
- 接口模块
- 用例模块
- 配置模块
- 内置函数模块
- 环境变量模块
- 套件模块

- 用户模块

### 二、项目工程搭建

#### 1.搭建项目

#### 2.基本配置

### 三、用户模块

#### 1.修改django用户模型

- 创建并注册子应用

- 子应用模型继承AbstractUser，重新定义属性
- 全局配置文件指定AUTH_USER_MODEL = 'user.models.USer'

#### 2.session认证

- DRF全局配置文件指定认证类型和权限

  ```python
  # 认证类型
  'DEFAULT_AUTHENTICATION_CLASSES': [
          'rest_framework.authentication.SessionAuthentication',
          'rest_framework.authentication.BasicAuthentication'
      ],
   # 权限类型
  'DEFAULT_PERMISSION_CLASSES': [
          'rest_framework.permissions.AllowAny',
      ],
  ```

- 修改DRF的认证和授权

  ```python
  # 直接在项目全局指定文件中重写其认证和授权即可,DRF默认使用的认证方式是session认证
  REST_FRAMEWORK = {
          'DEFAULT_AUTHENTICATION_CLASSES': [
          'rest_framework.authentication.SessionAuthentication',
          'rest_framework.authentication.BasicAuthentication'
      ],
      'DEFAULT_PERMISSION_CLASSES': [
          # permissions类下定义了多种认证方式，IsAuthenticated表示登录授权
          'rest_framework.permissions.IsAuthenticated',
      ],
  }
  ```
  - 也可以在具体类中指定

    ```python
    class ProjectViewset(viewsets.ModelViewSet):
        authentication_classes = [authentication.SessionAuthentication, authentication.BasicAuthentication]
        permission_classes = [permissions.IsAuthenticated]
    ```

  - DRF自带的权限

    - AllowAny
    - IsAuthenticated
    - IsAdminUser
    - IsAuthenticatedOrReadonly

- 创建可登录的api界面

  1. 指定上面的认证和授权方式

  2. 全局路由里面指定django或restframework下的路由

     ```python
     # 只要视图是继承APIView的接口，都可以登录后访问
     urlpatterns = [
         path('api/', include('rest_framework.urls')),
     ]
     ```

  3. 创建超级管理员

     ```python
     python manage.py createsuperuser
     ```

- session认证机制
  1. 第一次登录服务器，发送带有用户名密码的post请求
  2. 服务器验证通过后分配一个唯一的sessionid
  3. 服务器将sessionid存到响应头的set-cookie中
  4. 浏览器将set-cookie中的sessionid存到cookie中
  5. 下一次登录，发送带有sessionid cookie请求
  6. 服务器根据sessionid是否过期、用户信息是否正确等
  7. 返回响应信息

#### 3.token认证

##### 1.token的组成

header、playload、signature

- header
  - 声明类型
  - 声明加密算法，默认为H256
  - base64加密

- playload
  - 存放过期时间、签发用户等
  - 可以添加用户的非敏感信息
  - base64加密
- signature
  - 由三部分组成
  - 使用base64加密后的header+.+使用base64加密后的playload+使用H256算法加密，同时secret加盐处理

- token认证机制
  1. 第一次登录服务器，发送带有用户名密码的post请求
  2. 服务器进行身份验证，验证通过，生成token并返回
  3. 客户端将token存入会话存储或本地存储中，客户端将token放在请求头中发送请求
  4. 服务器判断token是否过期并验证其正确性
  5. 返回响应

##### 2.django中使用token认证

可以使用django中自带模块pyjwt，也可以使用第三方模块djangorestframework-jwt模块

1. 安装djangorestframework-jwt

   ```python
   pip install djangorestframework-jwt
   ```



```python 
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework_jwt.authentication.JSONWebTokenAuthentication',
        ],
}    
```

56未笔记完

