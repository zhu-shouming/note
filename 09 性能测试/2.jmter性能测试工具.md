#### jmeter基础

##### jmeter环境和配置

- jmeter依赖`jdk1.8`
- 修改语言为中文：修改bin/jmeter.properties文件language=zh_CN，保存并重启jmeter

##### jmeter文件目录

- /bin/：jmeter配置文件、启动文件及默认保存脚本路径
  - jmeter.bat：windows启动文件
  - jmeter.sh：linux启动文件，启动命令sh jmeter
  - ApacheJMeter.tar：通用启动命令java -jar ApacheJMeter.tar
  - templates/：用于生成html报告
- /docs/：api文件，用于jmeter二次开发
- /printable_docs/：jmeter离线帮助文档
- /lib/：源码包文件
  - /ext/：jmeter第三方插件

#### jmeter功能

- 测试计划：脚本的根
  - 线程（用户）
    - 线程组：进行性能场景设计
      - 取样器：根据不同的协议，选择不同的取样器。主要用于编写脚本，发起请求。
      - 逻辑控制器：控制脚本执行逻辑，先于取样器执行。作用范围：子集取样器
      - 前置处理器：
      - 后置处理器：处理取样器执行结果
        - json取样器：当响应结果为json时，优先使用json提取器
          - json提取器语法格式：**$.节点名称**，从根节点开始，多级节点之间用**.**表示
          - json提取器可提取多个值，在March No.输入框填负数
          - 也可以输入多个表达式，表达式之间用**;**隔开，变量名称、对应数量也要和其对应
        - 正则表达式：提取响应体、响应头、响应行及请求内容
          - 正则表达式语法：**左边界(正则表达式)右边界**
          - 万能正则表达式：**.*?**
            - 点号.：匹配除换行符之外的任一字符
            - 星号*：匹配0次或多次字符，默认贪婪模式
            - 加号+：至少匹配一次
            - 问号？：1.匹配前面的字符0或1次;2.关闭贪婪模式
            - [0-9]、\d：匹配数字   \D匹配非数字
            - [a-zA-Z]：匹配所有的大小写字母
            - \w匹配英文字母或数字的字符串    \W匹配非字母或数字的字符串
      - 逻辑控制器：控制取样器的执行逻辑
        - if条件控制
          - 默认请求下，必须使用`jexl3`或者`groovy`函数把表达式的结果计算出来
          - 去掉Interpret Condition as Variables Expression可直接填写表达式
        - foreach控制器：对一个明确的列表数据进行操作
        - 仅一次控制器：启动时，每个线程只会执行一次
        - 循环控制器
        - 事务控制器
    - setUp线程组：前置场景
    - tearDown线程组：后置场景
  - 配置元件：`优先级最高`,可置于测试计划下、线程组下、取样器下。相同key值取最近配置元件的value值，不同key值叠加。
    - HTTP信息头管理器：存放请求头部信息
    - HTTP请求默认值：可存放请求相关信息，多用于存放项目的根地址
    - CSV数据文件设置：数据驱动
  - 监听器：根据不同的维度展示执行的结果
    - 查看结果树：显示http请求的响应

##### 脚本编写注意事项：

1. 当请求体为json格式时，配置元件-请求头中必须添加：`Content-Type=application/json;charset=utf-8`;当请求体为表单格式，默认为`Content-Type=application/x-www-form-urlencoded`

2. 取样器-服务器名或IP不能携带/
3. 当get请求携带参数需带加密的数据，需要在参数重勾选`编码`

4. 如果请求体有中文，请求处的内容编码需添加utf-8

备：请求头中添加charset=utf-8用作控制json格式请求体的内容编码；请求参数编码，表单参数、有非字母/数字都需要勾选，且建议默认勾选；内容编码控制请求体的编码，建议默认填写utf-8。

##### 变量定义

jmeter变量名称遵循java变量名定义规则

变量的引用：`${变量名}`

变量定义的方法：

1. 用户定义变量：全局有效，跨线程组使用
   1. 测试计划里面定义变量
   2. 配置元件中用户定义变量
2. 用户参数--前置处理器
   - 用户参数挂载测试计划下，多个线程组中可引用
   - 挂载在某一个线程组下，当前线程组中可引用，其它线程不能
   - 挂载在某一个取样器下，当前取样器或在取样器之下的取样器可引用，在当前取样器上不能引用

注：测试计划中复选框--》独立运行每个线程组，不勾选表示测试计划下的每个线程组是并行运行，勾选表示线程组从上到下依次运行

##### 函数

jmeter函数（函数名严格区分大小写）分为：

1. 自带函数：Tools->函数助手对话框

   - ${__Random(,,)}：随机数函数

     - **用户定义的变量在使用随机数时，启动脚本的时候生成一个值，运行过程不会动态获取**
     - **用户参数在使用随机数时，不同接口调用用户参数会动态获取，如果想让多个接口使用相同的值，需要：**
       1. **把用户参数放在第一个取样器的子集中**
       2. **勾选用户参数`每次迭代更新一次`复选框**

   - 时间相关函数：

     1. ${__time(,)}：生成时间戳，可格式化时间
     2. ${__timeShift(,,,,)}：时间偏移函数
     3. ${__dateTimeConvert(,,,)}：时间格式转换函数

   - 计数函数

     - ${__counter(,)}：每次只能+1。如果需要使用+2、+3操作，需要使用计数器元件。

   - 加密函数

     - ${__digest(,,,,)}：只能进行简单加密。如果是复杂类型加密，需要code。

     注：1.性能脚本中，不要使用`${__BeanShell(,)}`，它的性能非常差;

     2.写java代码可以使用JSR223元件，对应函数可用`${__jexl3(,)}`或`${__groovy(,)}`。也可以将加密文件的源代码打包成jar文件，放在jmeter的lib\目录下，重启jmeter。不要使用测试计划下引入库功能。

   - 整数的加法运算：${__intSum(,,)}

   - 属性相关函数

     > jmeter所有的以.properity结尾的文件都是jmeter的属性配置文件
     >
     > 同时属性分为动态属性、静态属性，在jmeter中又可分为jmeter属性、系统属性
     >
     > 属性和变量的区别：
     >
     > 1. 变量可分为用户定义变量和用户参数
     >    - 用户定义变量可跨线程组使用，但是不会动态变化；用户参数在线程组中时，不能跨线程组使用，运行过程中动态变化
     > 2. 属性时工具所有，可以在jmeter中任意地方访问。用户参数接收属性，值不仅可以动态变化，也可以跨线程组使用

     - ${__setProperty(,,)}：设置属性
     - ${\_\_P(,)}或${\_\_property(,,)}：获取属性

   - 拼接函数

2. 扩展函数：需要使用第三方扩展包

#### DDT数据驱动性能测试

##### CSV数据文件设置（配置元件）

> 1. 添加csv数据文件设置，文件名不能为空
> 2. 定义的变量名称会接收csv文件中的值，启动运行时会自动读取第一行的值。如果有循环次数，会自动获取下一行的值。变量名称用逗号分隔，可以获取多个列的值
> 3. 忽略首行将忽略csv文件第一行的值
> 4. 分隔符：csv文件内容换行的分隔符
> 5. csv文件路径和jmx脚本路径放在相同位置，使用/斜杆表示路径可以跨平台使用脚本；在使用CLI命令进行性能测试时，建议把csv文件放在jmeter命令的执行路径下。

#### 机遇其它协议脚本编写

- soap、jdbc、websocket、mq、dubbo

##### JDBC

- 用于执行sql语句的javaapi

jmeter使用jdbc协议：

1. 需要数据库驱动（maven仓库中下载后，放在jmeter工具lib\ext目录下）
2. 使用jmeter连接数据库
   1. 添加-配置元件-JDBC Connection Configuration，填写对应信息
      - Variable Name for created pool：连接池名称，可随便定义。在JDBC取样器中需要用到
      - DataBase URL：格式**dbc:mysql://{ip}:{port}/{dbname}**
      - JDBC Driver Class：对应的驱动，当数据库版本为5.7.x时，驱动可选择com.mysql.jsbc.Driver;
      - Username：数据库用户名
      - Password：数据库密码
   2. 线程组-添加-取样器-JDBC Request
      - Variable Name Bound to pool：添加数据库连接池名称
      - 选择对应Query Type，并写入需要使用的sql语句
      - 添加结果数，运行即可查看结果